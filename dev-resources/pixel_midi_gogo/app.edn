[TodoItem :text "Hello, world!"]
[NewTodo :text ""]
[EditTodo :text "" :record nil]
[Mouse :x 0 :y 0]

:when
[Event :data (= (:id %) :pointer), :options ?opts]
:select
[?mouse <- Mouse]
:update
[?mouse :x (get ?opts "clientX") :y (get ?opts "clientY")]

:when
[View]
:select
[?event <- Event :data (= (:id %) :client-rect)]
:execute
(on-mount ?event)

:when
[?mouse <- Mouse]
[View]
:select
[?event <- Event :data (= (:id %) :client-rect)]
:upsert
[Canvas
 :parent "#game"
 <-
 :value
 [:fill {:color "lightblue"}
  [:rect {:width 250 :height 250}
   [:fill {:color "red"}
    [:ellipse {:width 50
               :height 50
               :x (- (:x ?mouse) (get-in ?event [:options "left"] 0))
               :y (- (:y ?mouse) (get-in ?event [:options "top"] 0))}]]]]]

:when
[Event :data (= (:id %) :input), :options ?opts]
:select
[?input <- NewTodo]
:update
[?input :text (get-in ?opts ["target" "value"])]

:when
[Event :data (= (:id %) :add-btn)]
:select
[?input <- NewTodo]
:insert
[TodoItem :text (:text ?input)]
:update
[?input :text ""]

:when
[?event <- Event :data (= (:id %) :rem-btn)]
:delete
(:record (:data ?event))

:when
[?event <- Event :data (= (:id %) :edit-btn)]
:select
[?edit <- EditTodo]
:update
[?edit
 :text (:text (:record (:data ?event)))
 :record (:record (:data ?event))]

:when
[?event <- Event :data (= (:id %) :cancel-btn)]
:select
[?edit <- EditTodo]
:update
[?edit :text "", :record nil]

:when
[?event <- Event :data (= (:id %) :edit), :options ?opts]
:select
[?edit <- EditTodo]
:update
[?edit
 :text (get-in ?opts ["target" "value"])
 :record (:record (:data ?event))]

:when
[?event <- Event :data (= (:id %) :save-btn)]
:select
[?edit <- EditTodo]
:update
[?edit :text "", :record nil]
[(:record (:data ?event)) :text (:text ?edit)]

:when
[?items <<- TodoItem]
[?input <- NewTodo]
[?edit <- EditTodo]
:upsert
[View
 :parent "#app"
 <-
 :value [:div
         [:input {:value (:text ?input)
                  :on-change {:id :input}}]
         [:button {:on-click {:id :add-btn}
                   :disabled (empty? (:text ?input))}
          "Add item"]
         (into [:ul]
           (for [item (sort-by :timestamp ?items)]
             [:li
              (if (= (:record ?edit) item)
                [:div
                 [:input {:value (:text ?edit)
                          :on-change {:id :edit
                                      :record item}}]
                 [:button {:on-click {:id :cancel-btn}}
                  "Cancel"]
                 [:button {:on-click {:id :save-btn
                                      :record item}}
                  "Save"]]
                [:div
                 (:text item)
                 [:button {:on-click {:id :edit-btn
                                      :record item}}
                  "Edit"]
                 [:button {:on-click {:id :rem-btn
                                      :record item}}
                  "Remove"]])]))
         [:div {:id "game"
                :on-mouse-move {:id :pointer}}]]]

